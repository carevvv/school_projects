Аномалии происходящие, когда приходит одновременно несколько запросов

- Атомарность - свойство операции,  при котором она не моет быть выполнена частично.

Пример: два раза приложил карту, и все начало выполняться параллельно. и происходит состояние гонки.

Для этого и нужны транзакции.

``` sql
BEGIN TRANSACTION;

... // все запросы


COMMIT;/ROLLBACK;
```

После этого все запросы идут последовательно

Транзакции - весь запрос пользователя

Алгоритмы транзакции запрещают трогать строки, которые есть в запросе, основная идея заключается либо синхронизации своих версий строк/таблиц, к которым обращается транзакция(добавляется идентификатор транзакции и идентификатор времени), либо в создании блокировок на чтение/изменения данных в таблице(строк, таблиц, БД).

В sql каждый запрос - атомарный.
## Классы аномалий:
#### 1. Потерянное обновление

транзакция 1
``` sql
UPDATE tbl1 SET f2 = f2 + 20 WHERE f1 = 1;
```

транзакция 2
``` sql
UPDATE tbl1 SET f2 = f2 + 25 WHERE f1 = 1;
```
#### 2. Грязное чтение

транзакция 1
``` sql
UPDATE tbl1 SET f2 = f2 + 20 WHERE f1 = 1;
```

транзакция 2
``` sql
SELECT f2 FROM FROM tbl1 WHERE f1 = 1;
```

транзакция 1
``` sql
ROLLBACK;
```
#### 3. Неповторяющиеся чтение

РАБОТАЕТ ТОЛЬКО С INSERT!

транзакция 2
``` sql
SELECT f2 FROM tbl1 WHERE f1=1;
```

транзакция 1
``` sql
UPDATE tbl1 SET f2=f2+3 WHERE f1=1;
COMMIT;
```

транзакция 2
``` sql
SELECT f2 FROM tbl1 WHERE f1=1;
```

### 4.  Чтение «фантомов»

Теперь работает с INSERT!

транзакция 2
``` sql
SELECT SUM(f2) FROM tbl1;
```

транзакция 1
``` sql
INSERT INTO tbl1 (f1,f2) VALUES (15,20);
COMMIT;
```

транзакция 2
``` sql
SELECT SUM(f2) FROM tbl1;
```

### Изоляции:

**Изоляции** - низкоуровневые методы борьбы с аномалиям

Типы:
- Read uncomitted - решается теневой копией, в окончательном варианте строка будет иметь значение, определённое всем набором успешно выполненных транзакций.
- Read commited - можете прочитать только те данные, которые были закомичены(грязное чтение не выполнимо)
- Repeateble read - решается теневым копированием всей таблицы, любые изменения, которые сделал кто-то другой во время вашей транзакции, вам видны не будут(только UPDATE!).
- Serializable - транзакции должны выполниться так, как-будто они выполняются параллельно, но нам самом деле последовательно.  требует от транзакции того, чтобы состояние бд было одинаковым, при любой вариации последовательности выполнения транзакций, иначе бд запрет ее выполнять.  

*на сессии нужно будет написать, что от чего защищает и что пользователь видит при запросе.
[table](photo/20241128163711.png)


ACID(==atomiciby consistency isolation durability==) 



Типы сбоев
1. Мягкий
2. Тяжелый

При сбое используется журнал(Write-Ahead Log) - записывает(всегда), что вы хотели сделать,  когда бд не фурычит, вместе с этим записывается резервная копияю.